blueprint:
  name: Furnace — Start at Computed Preheat Time (v4, patched labels)
  description: Start heating at the learned preheat time, with vacation/home/forecast logic.
  domain: automation
  input:
    climate:
      name: Climate entity
      selector:
        entity:
          domain: climate
    preheat_start:
      name: Preheat Start helper (input_datetime.preheat_start)
      selector:
        entity:
          domain: input_datetime
    target_temp:
      name: Target temperature
      default: 74
      selector:
        number:
          min: 50
          max: 80
          step: 0.5
          unit_of_measurement: "°F"
    vacation:
      name: Vacation boolean (input_boolean.vacation)
      selector:
        entity:
          domain: input_boolean
    occupied:
      name: Occupied binary_sensor (binary_sensor.family_home)
      selector:
        entity:
          domain: binary_sensor

trigger:
  - platform: time
    at: !input preheat_start

condition:
  - condition: state
    entity_id: !input vacation
    state: 'off'
  - condition: or
    conditions:
      - condition: state
        entity_id: !input occupied
        state: 'on'
      - condition: template
        value_template: >-
          {{ states('input_number.preheat_unoccupied_cap')|float(0) > 0 }}

action:
  - service: climate.set_temperature
    target:
      entity_id: !input climate
    data:
      temperature: !input target_temp
  - service: climate.set_hvac_mode
    target:
      entity_id: !input climate
    data:
      hvac_mode: heat
  - service: input_boolean.turn_on
    target: { entity_id: input_boolean.preheat_active }
  

mode: single
